<%- include("../partials/head.ejs") %>
    </head>

    <body>

        <%- include("../partials/side-nav.ejs") %>

            <div class="content-body">
                <!-- navbar -->
                <%- include("../partials/header.ejs") %>

                    <!-- main content -->
                    <div class="content">
                        <!-- <div class="content-title">
                <h2>Form</h2>
            </div> -->
                        <!-- view section -->
                        <div class="frame-container">
                            <div class="frame-title">
                                <span>Document views</span>
                            </div>
                            <div class="frame-content px-6">
                                <div class="flex flex-wrap">

                                    <% data.document.forEach(document=> { %>
                                        <div class="lg:w-1/2 md:w-1/2 w-full mb-6">
                                            <span class="view-title">Category</span>
                                            <p class="view-details">
                                                <%= document.document_category %>
                                            </p>
                                        </div>
                                        <div class="lg:w-1/2 md:w-1/2 w-full mb-6">
                                            <span class="view-title">Reference Number</span>
                                            <p class="view-details">
                                                <%= document.reference_no %>
                                            </p>
                                        </div>
                                        <div class="lg:w-1/2 md:w-1/2 w-full mb-6">
                                            <span class="view-title">From</span>
                                            <p class="view-details">
                                                <%= document.entity_from %>
                                            </p>
                                        </div>
                                        <div class="lg:w-1/2 md:w-1/2 w-full mb-6">
                                            <span class="view-title">Campus</span>
                                            <p class="view-details">
                                                <%= document.entity_campus %>
                                            </p>
                                        </div>
                                        <div class="lg:w-1/2 md:w-1/2 w-full mb-6">
                                            <span class="view-title">School</span>
                                            <p class="view-details">
                                                <%= document.entity_school %>
                                            </p>
                                        </div>
                                        <div class="lg:w-1/2 md:w-1/2 w-full mb-6">
                                            <span class="view-title">Department</span>
                                            <p class="view-details">
                                                <%= document.entity_department %>
                                            </p>
                                        </div>
                                        <div class="lg:w-1/2 md:w-1/2 w-full mb-6">
                                            <span class="view-title">Details</span>
                                            <p class="view-details">
                                                <%= document.description %>
                                            </p>
                                        </div>
                                        <div class="lg:w-1/2 md:w-1/2 w-full mb-6">
                                            <span class="view-title">Record Entered by</span>
                                            <p class="view-details">
                                                <%= document.created_by %>
                                            </p>
                                        </div>
                                        <% }) %>

                                </div>
                                <!-- <div class="mx-auto bg-gray-50 rounded-lg shadow-md">
                    </div> -->
                            </div>
                        </div>

                        <!-- Upload File View Section -->
                        <div class="frame-container">
                            <div class="frame-title">
                                <span>Files</span>
                            </div>
                            <div class="frame-content">
                                <!-- List of files -->
                                <ul class="">
                                    <!-- File 1 -->
                                    <% data.fileVersions.forEach(file=> { %>
                                        <li
                                            class="flex items-center justify-between py-3 hover:bg-blue-50 rounded-md px-6">
                                            <span class="text-gray-700">
                                                <%= file.file_name %>
                                            </span>
                                            <a href="/file-versions/download-file/<%= file.version_id %>">
                                                <i class="fa-solid fa-download text-red-600"></i>
                                            </a>
                                        </li>
                                        <% }) %>

                                </ul>
                            </div>
                        </div>
                        <!--  -->
                        <!-- Review Actions -->
                        <div class="frame-container">
                            <div class="frame-title">
                                <span>Actions</span>
                            </div>
                            <div class="frame-content" id="review-action-wrapper">
                                <form class="flex flex-wrap gap-y-4" id="document-form">
                                    <!-- Status Type-->
                                    <div class="mb-4 w-full sm:w-1/2 lg:w-1/4 px-2">
                                        <div class="lms-input-container">
                                            <select id="status-type" class="lms-dropdropdown">
                                                <option value="" disabled selected hidden>Select Status</option>
                                                <% data.statusTypes.forEach(statusType=> { %>
                                                    <option value="<%= statusType.status_type %>">
                                                        <%= statusType.status_type %>
                                                    </option>
                                                    <% }) %>
                                            </select>
                                            <div class="lms-cut-dropdown"></div>
                                            <label for="status-type"
                                                class="lms-placeholder-dropdown">Status<span>*</span></label>
                                        </div>
                                    </div>

                                    <!-- Details -->
                                    <div class="mb-4 w-full sm:w-1/2 lg:w-1/4 px-2">
                                        <div class="lms-input-container ">
                                            <input id="comments" class="lms-input" type="text" placeholder="">
                                            <label for="comments" class="lms-placeholder">Comments</label>
                                        </div>
                                    </div>

                                    <div class="mb-4 w-full sm:w-1/2 lg:w-1/4 px-2 flex flex-col items-center">
                                            <p class="text-xs mb-2">Final Approval ?</p>
                                            <input type="checkbox" id="lms-toggle"
                                                class="lms-toggle-checkbox lms-input">
                                            <label for="lms-toggle" class="lms-toggle-label"></label>
                                    </div>

                                    <!-- Forward To -->
                                    <div id="forward-document" class="mb-4 w-full sm:w-1/2 lg:w-1/4 px-2">
                                        <div class="lms-input-container">
                                            <select id="forwarded-to" class="lms-dropdropdown">
                                                <option value="" disabled selected hidden>Forward To</option>
                                                <% data.documentStages.forEach(stage=> { %>
                                                    <option value="<%= stage.document_stage %>">
                                                        <%= stage.document_stage %>
                                                    </option>
                                                    <% }) %>
                                            </select>
                                            <div class="lms-cut-dropdown"></div>
                                            <label for="forwarded-to" class="lms-placeholder-dropdown">Forward
                                                To<span>*</span></label>
                                        </div>
                                    </div>

                               
                                    <!-- button -->
                                    <div class="w-full px-2">
                                        <button id="document-review-submit" type="submit"
                                            data-review-id="<%= data.documentReviews.review_id %>"
                                            class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded w-full sm:w-auto">
                                            Submit
                                        </button>
                                    </div>

                                </form>
                            </div>
                        </div>
                        <!--  Review Actions//-->
                    </div>
                    <!-- main content// -->
            </div>

            <script src="https://kit.fontawesome.com/16de02e9e0.js" crossorigin="anonymous"></script>
            <script src="/js/utils.js"></script>
            <script src="/js/fetch.js"></script>
            <script src="/js/validation.js"></script>

            <script>
                document.getElementById("lms-toggle").addEventListener("click", async () => {
                    let isChecked = document.getElementById("lms-toggle").checked;
                    if (isChecked) {
                        document.getElementById("forwarded-to").firstElementChild.selected = true;
                        document.getElementById("forward-document").classList.add("hidden");
                    } else {
                        document.getElementById("forward-document").classList.remove("hidden");
                    }
                });

                document.getElementById("document-review-submit").addEventListener("click", async (event) => {
                    event.preventDefault();
                    const review_id = event.target.getAttribute("data-review-id");
                    const status = document.getElementById("status-type").value;
                    const comments = document.getElementById("comments").value;
                    const is_final_approval = document.getElementById("lms-toggle").checked;
                    let forwarded_to = is_final_approval != true ? document.getElementById("forwarded-to").value : null;

                    const url = '/document-reviews/update';
                    const method = 'POST';
                    const obj = { review_id, status, comments, is_final_approval, forwarded_to };

                    const fields = [
                        { value: status, name: 'Status' },
                        { value: comments, name: 'Comments' },
                    ];

                    const checkVal = isRequired(fields);

                    if (checkVal) {
                        const { error, data } = await fetchApi(url, method, obj);

                        if (error) {
                            alert(error.message);
                            return;
                        }

                        if (data) {
                            document.getElementById("status-type").firstElementChild.selected = true;
                            document.getElementById("comments").value = '';
                            document.getElementById("forwarded-to").firstElementChild.selected = true;
                            document.getElementById("lms-toggle").checked = false;
                            alert(data.message);
                        }
                        console.log('data ', JSON.stringify(data));
                    }
                });

            </script>
    </body>

    </html>