<%- include("./partials/head.ejs") %>
<style>
    .dashboard-stat-card {
        border: 1px solid #e5e9f1;
        box-shadow: 0px 2px 8px 0px #00000012;
        border-radius: 16px;
    }

    .chart-pie {
        border: 1px solid #e5e9f1;
        box-shadow: 0px 2px 8px 0px #00000012;
        border-radius: 16px;
        height: 400px;
    }

    .chart-bar {
        border: 1px solid #e5e9f1;
        box-shadow: 0px 2px 8px 0px #00000012;
        border-radius: 16px;
    }

    #chart {
        max-width: 650px;
        margin: 35px auto;
    }
</style>
</head>
<body>

    <%- include("./partials/side-nav.ejs") %>

    <div class="content-body">
        <!-- navbar -->
            <%- include("./partials/header.ejs") %>

        <!-- main content -->
        <div class="content space-y-7">
            <!-- Stats -->
            <div class="dashboard-stats grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-7 text-center ">
                <div class="dashboard-stat-card border px-4 py-6 hover:text-red-600">
                    <span class="stat-value text-3xl font-bold"><%- data.docsCreatedCount %></span>
                    <p class="stat-label text-gray-600">Docs Created</p>
                </div>
                <div class="dashboard-stat-card border px-4 py-6 hover:text-red-600">
                    <span class="stat-value text-3xl font-bold"><%- data.docsReceivedCount %></span>
                    <p class="stat-label text-gray-600">Docs Received</p>
                </div>
                <div class="dashboard-stat-card border px-4 py-6 hover:text-red-600">
                    <span class="stat-value text-3xl font-bold"><%- data.docsPendingCount %></span>
                    <p class="stat-label text-gray-600">Pending</p>
                </div>
                <div class="dashboard-stat-card border px-4 py-6 hover:text-red-600">
                    <span class="stat-value text-3xl font-bold"><%- data.docsApprovedCount %></span>
                    <p class="stat-label text-gray-600">Approved</p>
                </div>
                <div class="dashboard-stat-card border px-4 py-6 hover:text-red-600">
                    <span class="stat-value text-3xl font-bold"><%- data.docsRejectedCount %></span>
                    <p class="stat-label text-gray-600">Rejected</p>
                </div>
            </div>

            <!-- Charts -->
            <div class="dashboard-charts grid grid-cols-1 sm:grid-cols-1 lg:grid-cols-2 gap-7">
                <div class="chart-pie flex flex-col justify-center items-center bg-white shadow-md rounded-lg p-5">
                    <!-- <span class="font-bold text-lg mb-4">Pie Chart</span> -->
                    <div id="pie-chart" class="w-full"></div>
                </div>

                <div class="chart-bar flex flex-col justify-center items-center bg-white shadow-md rounded-lg p-5">
                    <!-- <span class="font-bold text-lg mb-4">Bar Chart</span> -->
                    <div id="bar-chart" class="w-full"></div>
                </div>
            </div>

            <div class="frame-container" id="document-list">
                <div class="frame-title">
                    <span>Documents</span>
                </div>
                <div class="frame-content">
                    <div class="mx-auto rounded-lg ">
                        <select id="row-per-page" class="row-per-page">
                            <option value="10">10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <!-- Table -->
                        <div class="responsive-table overflow-x-auto">
                            <table class="min-w-full bg-white rounded-b-lg shadow">
                                <thead class="text-left">
                                    <tr>
                                        <th class="p-4 text-xs font-bold text-center">S.No</th>
                                        <th class="p-4 text-xs font-bold">Ref. No.</th>
                                        <th class="p-4 text-xs font-bold">Doc Status</th>
                                        <th class="p-4 text-xs font-bold">Reviewer</th>
                                        <th class="p-4 text-xs font-bold">Review Status</th>
                                        <th class="p-4 text-xs font-bold">Category</th>
                                        <th class="p-4 text-xs font-bold">Received From</th>
                                        <th class="p-4 text-xs font-bold">University</th>
                                        <th class="p-4 text-xs font-bold">Campus</th>
                                        <th class="p-4 text-xs font-bold">School</th>
                                        <th class="p-4 text-xs font-bold">Department</th>
                                        <th class="p-4 text-xs font-bold">Comments</th>
                                        <th class="p-4 text-xs font-bold text-center">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                   
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-8 flex justify-end">
                            <div class="custom-pagination"></div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
         <!-- main content// -->
    </div>

    <script src="https://kit.fontawesome.com/16de02e9e0.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="<%- BASE_URL %>js/utils.js"></script>
    <script src="<%- BASE_URL %>js/fetch.js"></script>
    <script src="<%- BASE_URL %>js/pagination.js"></script>

    <script>
        let perPageData = 10;
        let totalDataCount = 100;
        let pageNum = 1;
        let totalPages = Math.ceil(Number(totalDataCount) / perPageData);
        let paginationArr = [];
        let dataFilterObj = {
            getTotalCount: false,
            pageNo: 1,
            cursor: undefined,
            filterCriteria: [],
            searchCriteria: {
                searchColumns: [],
                searchTerms: []
            },
            orderCriteria: [],
            pageSize: perPageData,
            findById: false
        };

        createPaginationDynamic(totalPages, pageNum, '#document-list');


        let filterCriteria = [
            { logicalName: "documentStatus", value: 'PENDING' }
        ];
        updateDataFilters({ filterCriteria, pageNo: 1, cursor: '' });

        //GRAPH LOGIC
        (function(){
            function formatApprovalTime(totalHours) {
                const days = Math.floor(totalHours / 24); // Get the number of full days
                const remainingHours = totalHours % 24; // Get the remaining hours after full days
                const hours = Math.floor(remainingHours); // Get the integer part of hours
                const minutes = Math.round((remainingHours - hours) * 60); // Convert fractional hours to minutes

                return `${days} days, ${hours} hours, ${minutes} minutes`;
            }   

            // PIE CHART CONFIGURATION
            let reportData = '<%- JSON.stringify(data) %>';
            reportData = JSON.parse(reportData);
            const pieOptions = {
                chart: {
                    type: 'pie',
                    width: '100%',
                    height: '100%'
                },
                series: [
                    Number(reportData.docsCreatedCount),
                    Number(reportData.docsReceivedCount),
                    Number(reportData.docsPendingCount),
                    Number(reportData.docsApprovedCount),
                    Number(reportData.docsRejectedCount)
                ],
                labels: ['Docs Created', 'Docs Received', 'Pending', 'Approved', 'Rejected'],
                colors: ['#1ec9c9', '#2196F3', '#FFC107', '#8BC34A', '#F44336'], // Custom colors
                dataLabels: {
                    enabled: true,
                    formatter: function (val, opts) {
                        // Show the number (raw value) instead of percentage
                        return opts.w.config.series[opts.seriesIndex];
                    },
                    style: {
                        fontSize: '14px',
                        fontWeight: 'bold'
                    }
                },
            };

            const pieChart = new ApexCharts(document.querySelector("#pie-chart"), pieOptions);
            pieChart.render();

            // BAR CHART CONFIGURATION
            const approvalStats = reportData.docsApprovalTimeStats;
            const barOptions = {
                chart: {
                    type: 'bar',
                    width: '100%',
                    height: '100%'
                },
                series: [{
                    name: 'Approval Time',
                    data: [
                        approvalStats.average_time_in_hours, 
                        approvalStats.min_time_in_hours, 
                        approvalStats.max_time_in_hours
                    ] // Avg, Min, Max Approval Times
                }],
                xaxis: {
                    categories: ['Avg. Time', 'Min. Time', 'Max. Time']
                },
                colors: ['#4CAF50', '#2196F3', '#F44336'], // Custom colors for bars
                plotOptions: {
                    bar: {
                        distributed: true, // Distribute colors to each bar
                        dataLabels: {
                            position: 'top' // Display data labels above bars
                        }
                    }
                },
                dataLabels: {
                    enabled: true,
                    formatter: function (val) {
                        return val + ' hrs';
                    },
                    style: {
                        fontSize: '14px',
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    y: {
                        formatter: function (val) {
                            return formatApprovalTime(val);
                        }
                    }
                },
                title: {
                    text: 'Approval Times (in hours)',
                    align: 'center',
                    style: {
                        fontSize: '16px',
                        fontWeight: 'bold'
                    }
                }
            };
        
            const barChart = new ApexCharts(document.querySelector("#bar-chart"), barOptions);
            barChart.render();
        })();


        // GLOBAL FUNCTION
        //pagination functon
        function paginationAjax(dataObj) {
            console.log('>>>>>>> CALLING PAGINATION', dataObj);
            let pageNum = dataObj.pageNo;
            let perPageData = dataObj.pageSize;

            $.ajax({
                type: "GET",
                url: `<%- BASE_URL %>documents/fetch`,
                data: dataObj,
                beforeSend: function () {
                    //$('#car-loader').modal('show');
                },
                success: function (data) {
                    console.log('data>>>> ', data);
                    //$('#main-table-wrapper').removeClass('d-none');
                    updateDataFilters({ getTotalCount: false });
                    totalDataCount = data?.totalDataCount || 0;

                   // $('.search-result-count-wrapper .count').text(totalDataCount);

                    let trStr = '';
                    let totalPages = Math.ceil(Number(totalDataCount) / perPageData);
                    let dataListArr = data.dataList || [];
                    let serialNum = (pageNum - 1) * perPageData + 1;

       
                    dataListArr.forEach((booking, idx) => {

                        trStr += `<tr data-lid="${booking.json_data.id}" data-trip-status="${tripStatus}" data-json="${ encodeURIComponent(JSON.stringify(booking.json_data)) }">
                        <td class="col-sl-no" scope="col">${serialNum++} 
                            ${checkbox}
                        </td>
                        <td class="col-actions">
                            <button type="button" class="btn btn-light btn-sm trigger-context-menu">
                            <img data-bs-toggle="tooltip" data-bs-title="Actions" src="/img/cog.png" title="Actions">
                            </button>
                        </td>
                        <td class="col-status" scope="col" data-status="${tripStatus}"><span class="badge" data-status="${tripStatus}">${tripStatus.split('_').join(' ')}</span></td>
                        <td class="col-ref-no" scope="col">${bookingRefNo}</td>
                        <td class="col-reservation-date" scope="col">${reservationDateStr}</td>
                        <td class="col-created-by" data-bs-toggle="tooltip" data-bs-title="${createdByWithPhone}" scope="col">${createdBy}</td>
                        <td class="col-corp text-ellipsis-200" data-bs-toggle="tooltip" data-bs-title="${corporateDetails.corporate_name}|${corporateDetails.corporate_branch}" scope="col">${corporateDetails.corporate_name} | ${corporateDetails.corporate_branch}</td>
                        <td class="col-pax-name text-ellipsis-200" data-bs-toggle="tooltip" data-bs-title="${paxNamesWithPhone}" scope="col">${paxNames}</td>
                        <td class="col-booking-tag text-ellipsis-200" data-bs-toggle="tooltip" data-bs-title="${bookingTagsTooltip || 'N.A'}" scope="col">${bookingTagsBadge}</td>
                        <td class="col-vehicle-cat" scope="col">${vehicleDetails.vehicle_cat_type}</td>
                        <td class="col-vehicle-details" scope="col">${allocatedVehicle ?? 'N.A'}</td>
                        <td class="col-driver" scope="col" data-bs-toggle="tooltip" data-bs-title="${driverNameWithPhone}">${driverName ?? 'N.A'}</td>
                        <td class="col-package" scope="col">${reservationDetails.package_name}</td>
                        <td class="col-service-city" scope="col">${reservationDetails.service_city}</td>
                        <td class="col-reporting-place text-ellipsis-200" data-bs-toggle="tooltip" data-bs-title="${reservationDetails.reporting_place || 'N.A'}" scope="col">${reservationDetails.reporting_place}</td>
                        <td class="col-drop-place text-ellipsis-200" data-bs-toggle="tooltip" data-bs-title="${reservationDetails.drop_place || 'N.A'}" scope="col">${reservationDetails.drop_place}</td>
                        <td class="col-instructions text-ellipsis-200" data-bs-toggle="tooltip" data-bs-title="${reservationDetails.instructions || 'N.A'}" scope="col">${reservationDetails.instructions}</td>
                        </tr>
                        `;
                    });

                    $('#main-table tbody').html(trStr);
                    createPaginationDynamic(totalPages, pageNum, '#document-list');
                },
                error: function (errors) {
                $('#car-loader').modal('hide');
                console.log("errors", errors.responseJSON)
                createToast({
                    title: "ALERT",
                    msg: errors?.responseJSON?.message || "Something went wrong! Please try again later.",
                    type: "negative"
                });
                }
            })
        }
        //update Data Filters
        function updateDataFilters(newValues) {
        dataFilterObj = { ...dataFilterObj, ...newValues };
        };

    </script>


</body>

</html>