<%- include("./partials/head.ejs") %>
    </head>

    <body>
        <%- include("./partials/side-nav.ejs") %>
            <div class="content">
                <%- include("./partials/header.ejs") %>
                    <div class="content-title">
                        <h2>Form</h2>
                    </div>
                    <!-- <h2>title TITLE</h2> -->
                    <div class="frame-container">
                        <div class="frame-title">
                            <span>Document Categories</span>
                        </div>
                        <div class="frame-content">
                            <div class="flex flex-wrap gap-y-4">

                                <div class="mb-4 w-full sm:w-1/2 lg:w-1/4 px-2">
                                    <div class="lms-input-container">
                                        <input id="category-name" class="lms-input" type="text" placeholder="" value="">
                                        <label for="category-name" class="lms-placeholder">Category
                                            Name<span>*</span></label>
                                    </div>
                                </div>

                                <div class="mb-4 w-full sm:w-1/2 lg:w-1/4 px-2">
                                    <div class="lms-input-container">
                                        <input id="category-abbr" class="lms-input" type="text" placeholder="" value="">
                                        <label for="category-abbr" class="lms-placeholder">Category
                                            Abbreviation<span>*</span></label>
                                    </div>
                                </div>

                                <div class="mb-4 w-full sm:w-1/2 lg:w-1/4 px-2">
                                    <div class="lms-input-container">
                                        <input id="description" class="lms-input" type="text" placeholder="" value="">
                                        <label for="description"
                                            class="lms-placeholder">Description<span>*</span></label>
                                    </div>
                                </div>

                                <div class="mb-4 w-full sm:w-1/2 lg:w-1/4 px-2">
                                    <div class="lms-input-container">
                                        <select id="parent-category" class="lms-dropdropdown">
                                            <option value="" disabled selected hidden>Select Parent Category</option>
                                            <% documentCategories.forEach((type, index)=> { %>
                                                <option value="<%= type.category_id %>">
                                                    <%= type.document_category %>
                                                </option>
                                                <% }) %>
                                        </select>
                                        <div class="lms-cut-dropdown"></div>
                                        <label for="type" class="lms-placeholder-dropdown">Category
                                            Name<span>*</span></label>
                                    </div>
                                </div>


                                <!-- button -->
                                <div class="w-full px-2">
                                    <button id="submit-btn" type="submit"
                                        class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded w-full sm:w-auto">
                                        Add +
                                    </button>
                                </div>

                            </div>

                        </div>
                    </div>
                    <!-- Upload VIA EXCEL -->
                    <div class="frame-container">
                        <div class="frame-title"><span>Upload VIA EXCEL</span></div>
                        <div class="frame-content">
                            <form class="px-2" id="upload-categories-excel">
                                <div class="flex items-start gap-4">
                                    <label
                                        class="flex cursor-pointer items-center justify-center rounded-lg border border-dashed border-red-600 p-2 hover:border-solid ease-in-out bg-white space-x-2  w-48">
                                        <i class="fa-solid fa-arrow-up-from-bracket text-red-500"></i>
                                        <span class=" text-md">Upload File</span>
                                        <input name="excel-file-input" id="excel-file" type="file" accept=".xlsx,.xls"
                                            class="hidden" required />
                                    </label><!-- File count display -->
                                    <button type="submit" id="submit-excel-file"
                                        class="w-min-content p-2 border border-red-600 h-full bg-red-600 hover:bg-red-700 text-white font-semibold h-[44px] px-4 rounded-lg">
                                        Upload
                                    </button>
                                </div>
                                <p id="excel-file-info" class="text-sm text-gray-500 mt-2 ml-1">
                                    No files selected
                                </p>

                            </form>
                            <div id="download-category-excel"
                                class="space-x-2 mt-4 flex cursor-pointer flex items-center p-2 bg-white">
                                <i class="fa-regular fa-circle-down text-red-500"></i>
                                <span class="font-medium text-md text-nowrap cursor-pointer text-red-500">Download
                                    Template</span>
                            </div>

                        </div>
                    </div>
                    <!-- table -->
                    <div class="frame-container">
                        <div class="frame-title">
                            <span>Document Categories</span>
                        </div>
                        <div class="frame-content">
                            <div class="mx-auto bg-gray-50 rounded-lg shadow-md">
                                <!-- Table Header -->
                                <div class="flex justify-between items-center px-4 py-3 bg-blue-50 rounded-t-lg">
                                    <h2 class="text-lg font-semibold text-gray-700">Document Categories Table</h2>
                                    <!-- <button class="text-sm font-semibold text-gray-600">02 Document</button> -->
                                </div>

                                <!-- Table -->
                                <div class="responsive-table overflow-x-auto">
                                    <table class="min-w-full bg-white rounded-b-lg shadow">
                                        <thead class="text-left">
                                            <tr>
                                                <th class="p-4 text-xs font-bold text-center">S.No</th>
                                                <th class="p-4 text-xs font-bold ">Category Name</th>
                                                <th class="p-4 text-xs font-bold ">Category Abbreviation</th>
                                                <th class="p-4 text-xs font-bold ">Description</th>
                                                <th class="p-4 text-xs font-bold ">Parent</th>
                                                <th class="p-4 text-xs font-bold text-center">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Row 1 -->
                                            <% documentCategories.forEach((type, index)=> { %>
                                                <tr class="hover:bg-blue-50"
                                                    data-category-type="<%= type.category_id %>">
                                                    <td class="p-4 text-sm text-gray-700 text-center font-semibold ">
                                                        <%= index + 1 %>
                                                    </td>
                                                    <td class="p-4 text-sm text-gray-700 ">
                                                        <%= type.document_category %>
                                                    </td>
                                                    <td class="p-4 text-sm text-gray-700 ">
                                                        <%= type.category_abbr %>
                                                    </td>
                                                    <td class="p-4 text-sm text-gray-700 ">
                                                        <%= type.description %>
                                                    </td>
                                                    <td class="p-4 text-sm text-gray-700 ">
                                                    </td>
                                                    <td class="p-4 text-center relative">
                                                        <button onclick="toggleDropdown(event)"
                                                            class="focus:outline-none text-gray-600 px-4"><i
                                                                class="fa-solid fa-ellipsis-vertical"></i></button>

                                                        <!-- Dropdown menu -->
                                                        <div id="dropdown-0"
                                                            class="dropdown text-sm hidden absolute bottom-0 right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10">
                                                            <a href="#"
                                                                class="block px-4 py-2 text-gray-700 hover:bg-gray-100 flex items-center update-btn">
                                                                <i class="text-red-500 fa-solid fa-pen-to-square"></i>
                                                                <span class="ml-2">Update</span>
                                                            </a>
                                                            <a href="#"
                                                                class="block px-4 py-2 text-gray-700 hover:bg-gray-100 flex items-center delete-btn">
                                                                <i class="text-red-500 fa-solid fa-trash-can"></i><span
                                                                    class="ml-2">Delete</span>
                                                            </a>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <% }) %>

                                        </tbody>
                                    </table>
                                </div>
                            </div>

                        </div>
                    </div>

                    <div id="modal-background"
                        class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden"
                        style=" z-index: 1035;">
                        <!-- Modal Content -->
                        <div class="bg-white rounded-lg p-6 w-full max-w-sm">
                            <div id="modal-content">

                            </div>
                            <!-- Buttons -->
                            <div class="mt-6 flex justify-end space-x-4">
                                <button onclick="closeModal()" id="close-modal"
                                    class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                                    Cancel
                                </button>
                                <button id="update-submit-btn"
                                    class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                                    Update
                                </button>
                            </div>
                        </div>

                    </div>

                    <%- include("./home/loader.ejs") %>
                        <%- include("./home/toaster.ejs") %>
            </div>

            <script src="https://kit.fontawesome.com/16de02e9e0.js" crossorigin="anonymous"></script>
            <script src="<%- BASE_URL %>js/utils.js"></script>
            <script src="<%- BASE_URL %>js/fetch.js"></script>
            <script src="<%- BASE_URL %>js/validation.js"></script>

            <script>

                document.getElementById('submit-btn').addEventListener('click', async () => {
                    isLoader(true);
                    const document_category = document.getElementById('category-name').value;
                    const category_abbr = document.getElementById('category-abbr').value;
                    const description = document.getElementById('description').value;
                    const parent_id = document.getElementById('parent-category').value?.null;

                    const fields = [
                        { value: document_category, name: 'Category Name' },
                        { value: category_abbr, name: 'Category Abbreviation' },
                        { value: description, name: 'Description' },
                    ];

                    const checkVal = isRequired(fields);
                    if (!checkVal) isLoader(false);

                    if (checkVal) {

                        const url = '<%- BASE_URL %>document-categories/create';
                        const method = 'POST';
                        const obj = { document_category, category_abbr, description, parent_id };

                        const { error, data } = await fetchApi(url, method, obj);
                        isLoader(false);

                        if (error) {
                            showAlert({
                                alert: 'error',
                                message: error.message
                            });
                            return;
                        }

                        if (data) {
                            showAlert({
                                alert: 'success',
                                message: "Document Category Created Successfully !"
                            });
                            const category_id = data.category_id;
                            appendDataToTable({ document_category, category_abbr, description, parent_id, category_id });
                            document.getElementById('category-name').value = '';
                            document.getElementById('category-abbr').value = '';
                            document.getElementById('description').value = '';
                            document.getElementById('parent-category').firstElementChild.selected = true;
                        }
                        console.log('data ', JSON.stringify(data));
                    }
                });

                function appendDataToTable(data) {
                    let tableBody = document.querySelector('tbody');
                    let rowCount = tableBody.rows.length;

                    let tableRow = document.createElement('tr');
                    tableRow.innerHTML = `<td class="p-4 text-sm text-gray-700 text-center font-semibold ">
                                                        ${rowCount + 1}
                                                    </td>
                                                    <td class="p-4 text-sm text-gray-700 ">
                                                        ${data.document_category}
                                                    </td>
                                                    <td class="p-4 text-sm text-gray-700 ">
                                                        ${data.category_abbr}
                                                    </td>
                                                    <td class="p-4 text-sm text-gray-700 ">
                                                        ${data.description}
                                                    </td>
                                                    <td class="p-4 text-sm text-gray-700 ">
                                                    </td>
                                                    <td class="p-4 text-center relative">
                                                        <button onclick="toggleDropdown(event)"
                                                            class="focus:outline-none text-gray-600 px-4"><i
                                                                class="fa-solid fa-ellipsis-vertical"></i></button>

                                                        <div id="dropdown-0"
                                                            class="dropdown text-sm hidden absolute bottom-0 right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10">
                                                            <a href="#"
                                                                class="block px-4 py-2 text-gray-700 hover:bg-gray-100 flex items-center update-btn">
                                                                <i class="text-red-500 fa-solid fa-pen-to-square"></i>
                                                                <span class="ml-2">Update</span>
                                                            </a>
                                                            <a href="#"
                                                                class="block px-4 py-2 text-gray-700 hover:bg-gray-100 flex items-center delete-btn">
                                                                <i class="text-red-500 fa-solid fa-trash-can"></i><span
                                                                    class="ml-2">Delete</span>
                                                            </a>
                                                        </div>
                                                    </td>`
                    tableRow.classList.add('"hover:bg-blue-50"');

                    let lastChildDataId = document.querySelector('tbody').lastElementChild.getAttribute('data-category-type');
                    tableRow.setAttribute('data-category-type', data.category_id);
                    tableBody.appendChild(tableRow);
                }

                document.addEventListener("click", async function (event) {
                    if (event.target.closest(".delete-btn")) {
                        isLoader(true);
                        const row = event.target.closest("tr");
                        const category_id = row.getAttribute("data-category-type");

                        const url = '<%- BASE_URL %>document-categories/delete';
                        const method = 'POST';
                        const obj = { category_id };

                        const { error, data } = await fetchApi(url, method, obj);
                        isLoader(false);

                        if (error) {
                            showAlert({
                                alert: 'error',
                                message: error.message
                            });
                            return;
                        }

                        if (data) {
                            showAlert({
                                alert: 'success',
                                message: data.message
                            });
                            row.remove();
                        }
                    }

                    if (event.target.closest(".update-btn")) {
                        const row = event.target.closest("tr");
                        const category_id = row.getAttribute("data-category-type");

                        const url = `<%- BASE_URL %>document-categories/fetch/${category_id}`;
                        const method = 'GET';

                        const { error, data } = await fetchApi(url, method, null);

                        if (error) {
                            showAlert({
                                alert: 'error',
                                message: error.message
                            });
                            return;
                        }

                        if (data) {
                            console.log('data update ', JSON.stringify(data));
                            appenHtmlToModal(data);
                            openModal();
                        }

                    }
                });


                function appenHtmlToModal(data) {

                    const category_data = data ?? [];
                    const category_name = category_data[0].document_category;
                    const category_abbr = category_data[0].category_abbr;
                    const parent_id = category_data[0].parent_id ?? '';
                    const description = category_data[0].description;
                    const category_id = category_data[0].category_id;

                    const modalContent = `<div class="frame-container">
                        <div class="frame-title">
                            <span>Document Categories</span>
                        </div>
                        <div class="frame-content">
                            <div class="flex flex-col flex-wrap gap-y-4">

                                <div class="mb-4 w-full px-2">
                                    <div class="lms-input-container">
                                        <input id="category-name-edit" class="lms-input" type="text" placeholder="" value="${category_name}">
                                        <label for="category-name-edit" class="lms-placeholder">Category
                                            Name<span>*</span></label>
                                    </div>
                                </div>

                                <div class="mb-4 w-full px-2">
                                    <div class="lms-input-container">
                                        <input id="category-abbr-edit" class="lms-input" type="text" placeholder="" value="${category_abbr}">
                                        <label for="category-abbr-edit" class="lms-placeholder">Category
                                            Abbreviation<span>*</span></label>
                                    </div>
                                </div>

                                <div class="mb-4 w-full px-2">
                                    <div class="lms-input-container">
                                        <input id="description-edit" class="lms-input" type="text" placeholder="" value="${description}">
                                        <label for="description-edit"
                                            class="lms-placeholder">Description<span>*</span></label>
                                    </div>
                                </div>

                                <div class="mb-4 w-full px-2">
                                    <div class="lms-input-container">
                                        <select id="parent-category-edit" class="lms-dropdropdown">
                                            <option value="" disabled selected hidden>Select Parent Category</option>
                                            <% documentCategories.forEach((type, index)=> { %>
                                                <option value="<%= type.category_id %>">
                                                    <%= type.document_category %>
                                                </option>
                                                <% }) %>
                                        </select>
                                        <div class="lms-cut-dropdown"></div>
                                        <label for="type" class="lms-placeholder-dropdown">Category
                                            Name<span>*</span></label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`

                    document.getElementById("modal-content").innerHTML = modalContent;
                    document.getElementById("update-submit-btn").setAttribute("data-category-id", category_id);

                    const options = document.getElementById("parent-category-edit");
                    for (let i = 0; i < options.length; i++) {
                        if (options[i].value == parent_id) {
                            options[i].selected = true;
                            break;
                        }
                    }
                }

                document.getElementById('update-submit-btn').addEventListener('click', async (event) => {
                    isLoader(true);
                    const category_id = event.target.getAttribute("data-category-id");
                    const document_category = document.getElementById("category-name-edit").value;
                    const category_abbr = document.getElementById("category-abbr-edit").value;
                    const description = document.getElementById("description-edit").value;
                    const parent_id = document.getElementById("parent-category-edit").value?.null;

                    const fields = [
                        { value: document_category, name: 'Category Name' },
                        { value: category_abbr, name: 'Category Abbreviation' },
                        { value: description, name: 'Description' },
                    ];

                    const checkVal = isRequired(fields);
                    if (!checkVal) isLoader(false);

                    if (checkVal) {
                        const url = '<%- BASE_URL %>document-categories/update';
                        const method = 'POST';
                        const obj = { category_id, document_category, category_abbr, description, parent_id };

                        const { error, data } = await fetchApi(url, method, obj);
                        isLoader(false);

                        if (error) {
                            showAlert({
                                alert: 'error',
                                message: error.message
                            });
                            return;
                        }

                        if (data) {
                            showAlert({
                                alert: 'success',
                                message: data.message
                            });
                            document.getElementById('category-name-edit').value = '';
                            document.getElementById('category-abbr-edit').value = '';
                            document.getElementById('description-edit').value = '';
                            document.getElementById('parent-category-edit').options[0].selected = true;

                            const row = document.querySelector(`tr[data-category-type="${category_id}"]`);
                            const rowIndex = row.firstElementChild.innerText;
                            const tableBody = document.querySelector('tbody');
                            const rowCount = tableBody.rows.length;
                            row.innerHTML = `<td class="p-4 text-sm text-gray-700 text-center font-semibold ">
                                            ${rowIndex}
                                         </td>
                                         <td class="p-4 text-sm text-gray-700 ">
                                           ${document_category}
                                         </td>
                                         <td class="p-4 text-sm text-gray-700 ">
                                             ${category_abbr}
                                         </td>
                                        <td class="p-4 text-sm text-gray-700 ">
                                            ${description}
                                        </td>
                                        <td class="p-4 text-sm text-gray-700 ">
                                        </td>
                                        <td class="p-4 text-center relative">
                                            <button onclick="toggleDropdown(event)"
                                                class="focus:outline-none text-gray-600 px-4"><i
                                                    class="fa-solid fa-ellipsis-vertical"></i></button>

                                            <div id="dropdown-0"
                                                class="dropdown text-sm hidden absolute bottom-0 right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10">
                                                <a href="#"
                                                    class="block px-4 py-2 text-gray-700 hover:bg-gray-100 flex items-center update-btn">
                                                    <i class="text-red-500 fa-solid fa-pen-to-square"></i>
                                                    <span class="ml-2">Update</span>
                                                </a>
                                                <a href="#"
                                                    class="block px-4 py-2 text-gray-700 hover:bg-gray-100 flex items-center delete-btn">
                                                    <i class="text-red-500 fa-solid fa-trash-can"></i><span
                                                        class="ml-2">Delete</span>
                                                </a>
                                            </div>
                                        </td>`;

                            closeModal();
                        }
                        console.log('data ', JSON.stringify(data));
                    }
                });

                // Excel File Upload Event Listeners
                document.querySelector('#excel-file').addEventListener('change', function (event) {
                    const file = event.target.files[0];
                    const fileInfoElement = document.querySelector('#excel-file-info');
                    const validFile = validateExcelFile(file);

                    if (file) {
                        if (validFile) {
                            fileInfoElement.textContent = file.name;
                            fileInfoElement.classList.remove('text-red-500');
                            fileInfoElement.classList.add('text-gray-500');
                            document.querySelector('#submit-excel-file').disabled = false;
                        } else {
                            fileInfoElement.textContent = 'Invalid file type. Please upload an Excel file.';
                            fileInfoElement.classList.remove('text-gray-500');
                            fileInfoElement.classList.add('text-red-500');
                            document.querySelector('#submit-excel-file').disabled = true;
                            event.target.value = '';
                        }
                    } else {
                        fileInfoElement.textContent = 'No files selected';
                        document.querySelector('#submit-excel-file').disabled = true;
                    }
                });
                document.querySelector('#upload-categories-excel').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const fileInput = document.getElementById('excel-file');
                    const excelFile = fileInput.files[0];
                    const submitButton = document.querySelector("#submit-excel-file");
                    const fileInfoElement = document.querySelector('#excel-file-info');

                    // Validate file presence
                    if (!excelFile) {
                        fileInfoElement.textContent = 'Please select a file to upload';
                        fileInfoElement.classList.remove('text-gray-500');
                        fileInfoElement.classList.add('text-red-500');
                        return;
                    }

                    const formData = new FormData();
                    formData.append('excel', excelFile);

                    submitButton.disabled = true;
                    submitButton.innerHTML = `
                        <span class="flex items-center">
                            <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Uploading...
                        </span>
                    `;

                    const { error, data } = await fetchApi('<%- BASE_URL %>document-categories/create-via-excel', "POST", formData);

                    if (error) {
                        submitButton.disabled = false;
                        submitButton.innerHTML = 'Upload';
                        alert(error.message);
                        showAlert({
                            alert: 'error',
                            message: error.message
                        });
                        return;
                    }

                    if (data) {
                        submitButton.disabled = false;
                        submitButton.innerHTML = 'Upload';
                        showAlert({
                            alert: 'success',
                            message: data.message
                        });
                        location.reload();
                    }
                });


                // Excel File Download Event Listener
                document.querySelector("#download-category-excel").addEventListener("click", async (event) => {
                    try {
                        const response = await fetch('<%- BASE_URL %>document-categories/download-excel-categories');
                        const blob = await response.blob();

                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement("a");
                        a.href = url;
                        a.download = "document-categories.xlsx";
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        window.URL.revokeObjectURL(url);
                    } catch (error) {
                        showAlert({
                            alert: 'error',
                            message: error.message
                        });
                        console.error("Error downloading file:", error);
                    }
                });
            </script>
    </body>