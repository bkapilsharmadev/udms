<%- include("./partials/head.ejs") %>
    </head>

    <body>
        <%- include("./partials/side-nav.ejs") %>
            <div class="content">
                <%- include("./partials/header.ejs") %>
                    <div class="content-title">
                        <h2>Form</h2>
                    </div>
                    <!-- <h2>title TITLE</h2> -->
                    <div class="frame-container">
                        <div class="frame-title">
                            <span>Document Categories</span>
                        </div>
                        <div class="frame-content">
                            <div class="flex flex-wrap gap-y-4">

                                <div class="mb-4 w-full sm:w-1/2 lg:w-1/4 px-2">
                                    <div class="lms-input-container">
                                        <input id="category-name" class="lms-input" type="text" placeholder="" value="">
                                        <label for="category-name" class="lms-placeholder">Category
                                            Name<span>*</span></label>
                                    </div>
                                </div>

                                <div class="mb-4 w-full sm:w-1/2 lg:w-1/4 px-2">
                                    <div class="lms-input-container">
                                        <input id="category-abbr" class="lms-input" type="text" placeholder="" value="">
                                        <label for="category-abbr" class="lms-placeholder">Category
                                            Abbreviation<span>*</span></label>
                                    </div>
                                </div>

                                <div class="mb-4 w-full sm:w-1/2 lg:w-1/4 px-2">
                                    <div class="lms-input-container">
                                        <input id="description" class="lms-input" type="text" placeholder="" value="">
                                        <label for="description"
                                            class="lms-placeholder">Description<span>*</span></label>
                                    </div>
                                </div>

                                <div class="mb-4 w-full sm:w-1/2 lg:w-1/4 px-2">
                                    <div class="lms-input-container">
                                        <select id="parent-category" class="lms-dropdropdown">
                                            <option value="" disabled selected hidden>Select Parent Category</option>
                                            <% documentCategories.forEach((type, index)=> { %>
                                                <option value="<%= type.category_id %>">
                                                    <%= type.document_category %>
                                                </option>
                                                <% }) %>
                                        </select>
                                        <div class="lms-cut-dropdown"></div>
                                        <label for="type" class="lms-placeholder-dropdown">Category
                                            Name<span>*</span></label>
                                    </div>
                                </div>


                                <!-- button -->
                                <div class="w-full px-2">
                                    <button id="submit-btn" type="submit"
                                        class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded w-full sm:w-auto">
                                        Add +
                                    </button>
                                </div>

                            </div>

                        </div>
                    </div>

                    <!-- table -->
                    <div class="frame-container">
                        <div class="frame-title">
                            <span>Document Categories</span>
                        </div>
                        <div class="frame-content">
                            <div class="mx-auto bg-gray-50 rounded-lg shadow-md">
                                <!-- Table Header -->
                                <div class="flex justify-between items-center px-4 py-3 bg-blue-50 rounded-t-lg">
                                    <h2 class="text-lg font-semibold text-gray-700">Document Categories Table</h2>
                                    <!-- <button class="text-sm font-semibold text-gray-600">02 Document</button> -->
                                </div>

                                <!-- Table -->
                                <div class="responsive-table overflow-x-auto">
                                    <table class="min-w-full bg-white rounded-b-lg shadow">
                                        <thead class="text-left">
                                            <tr>
                                                <th class="p-4 text-xs font-bold text-center">S.No</th>
                                                <th class="p-4 text-xs font-bold ">Category Name</th>
                                                <th class="p-4 text-xs font-bold ">Category Abbreviation</th>
                                                <th class="p-4 text-xs font-bold ">Description</th>
                                                <th class="p-4 text-xs font-bold ">Parent</th>
                                                <th class="p-4 text-xs font-bold text-center">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Row 1 -->
                                            <% documentCategories.forEach((type, index)=> { %>
                                                <tr class="hover:bg-blue-50"
                                                    data-category-type="<%= type.category_id %>">
                                                    <td class="p-4 text-sm text-gray-700 text-center font-semibold ">
                                                        <%= index + 1 %>
                                                    </td>
                                                    <td class="p-4 text-sm text-gray-700 ">
                                                        <%= type.document_category %>
                                                    </td>
                                                    <td class="p-4 text-sm text-gray-700 ">
                                                        <%= type.category_abbr %>
                                                    </td>
                                                    <td class="p-4 text-sm text-gray-700 ">
                                                        <%= type.description %>
                                                    </td>
                                                    <td class="p-4 text-sm text-gray-700 ">
                                                    </td>
                                                    <td class="p-4 text-center relative">
                                                        <button onclick="toggleDropdown(event)"
                                                            class="focus:outline-none text-gray-600 px-4"><i
                                                                class="fa-solid fa-ellipsis-vertical"></i></button>

                                                        <!-- Dropdown menu -->
                                                        <div id="dropdown-0"
                                                            class="dropdown text-sm hidden absolute bottom-0 right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10">
                                                            <a href="#"
                                                                class="block px-4 py-2 text-gray-700 hover:bg-gray-100 flex items-center update-btn">
                                                                <i class="text-red-500 fa-solid fa-pen-to-square"></i>
                                                                <span class="ml-2">Update</span>
                                                            </a>
                                                            <a href="#"
                                                                class="block px-4 py-2 text-gray-700 hover:bg-gray-100 flex items-center delete-btn">
                                                                <i class="text-red-500 fa-solid fa-trash-can"></i><span
                                                                    class="ml-2">Delete</span>
                                                            </a>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <% }) %>

                                        </tbody>
                                    </table>
                                </div>
                            </div>

                        </div>
                    </div>

                    <div id="modal-background"
                        class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden"
                        style=" z-index: 1035;">
                        <!-- Modal Content -->
                        <div class="bg-white rounded-lg p-6 w-full max-w-sm">
                            <div id="modal-content">

                            </div>
                            <!-- Buttons -->
                            <div class="mt-6 flex justify-end space-x-4">
                                <button onclick="closeModal()" id="close-modal"
                                    class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                                    Cancel
                                </button>
                                <button id="update-submit-btn"
                                    class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                                    Update
                                </button>
                            </div>
                        </div>
                    </div>
            </div>

            <script src="https://kit.fontawesome.com/16de02e9e0.js" crossorigin="anonymous"></script>
            <script src="../js/utils.js"></script>
            <script src="../js/fetch.js"></script>
            <script>

                document.getElementById('submit-btn').addEventListener('click', async () => {
                    const document_category = document.getElementById('category-name').value;
                    const category_abbr = document.getElementById('category-abbr').value;
                    const description = document.getElementById('description').value;
                    const parent_id = document.getElementById('parent-category').value?.null;

                    const url = '/document-categories/create';
                    const method = 'POST';
                    const obj = { document_category, category_abbr, description, parent_id };

                    const {error,data} = await fetchApi(url, method, obj);

                    if(error){
                      alert(error.message); 
                      return;
                    }

                    if (data) {
                        const category_id = data.category_id;
                        appendDataToTable({ document_category, category_abbr, description, parent_id ,category_id });
                        document.getElementById('category-name').value = '';
                        document.getElementById('category-abbr').value = '';
                        document.getElementById('description').value = '';
                        document.getElementById('parent-category').firstElementChild.selected = true;
                        alert("Document Category Created Successfully !");
                    }
                    console.log('data ', JSON.stringify(data));
                });

                function appendDataToTable(data) {
                    let tableBody = document.querySelector('tbody');
                    let rowCount = tableBody.rows.length;

                    let tableRow = document.createElement('tr');
                    tableRow.innerHTML = `<td class="p-4 text-sm text-gray-700 text-center font-semibold ">
                                                        ${rowCount + 1}
                                                    </td>
                                                    <td class="p-4 text-sm text-gray-700 ">
                                                        ${data.document_category}
                                                    </td>
                                                    <td class="p-4 text-sm text-gray-700 ">
                                                        ${data.category_abbr}
                                                    </td>
                                                    <td class="p-4 text-sm text-gray-700 ">
                                                        ${data.description}
                                                    </td>
                                                    <td class="p-4 text-sm text-gray-700 ">
                                                    </td>
                                                    <td class="p-4 text-center relative">
                                                        <button onclick="toggleDropdown(event)"
                                                            class="focus:outline-none text-gray-600 px-4"><i
                                                                class="fa-solid fa-ellipsis-vertical"></i></button>

                                                        <div id="dropdown-0"
                                                            class="dropdown text-sm hidden absolute bottom-0 right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10">
                                                            <a href="#"
                                                                class="block px-4 py-2 text-gray-700 hover:bg-gray-100 flex items-center update-btn">
                                                                <i class="text-red-500 fa-solid fa-pen-to-square"></i>
                                                                <span class="ml-2">Update</span>
                                                            </a>
                                                            <a href="#"
                                                                class="block px-4 py-2 text-gray-700 hover:bg-gray-100 flex items-center delete-btn">
                                                                <i class="text-red-500 fa-solid fa-trash-can"></i><span
                                                                    class="ml-2">Delete</span>
                                                            </a>
                                                        </div>
                                                    </td>`
                    tableRow.classList.add('"hover:bg-blue-50"');

                    let lastChildDataId = document.querySelector('tbody').lastElementChild.getAttribute('data-category-type');
                    tableRow.setAttribute('data-category-type', data.category_id);
                    tableBody.appendChild(tableRow);
                }

                document.addEventListener("click", async function (event) {
                    if (event.target.closest(".delete-btn")) {
                        const row = event.target.closest("tr");
                        const category_id = row.getAttribute("data-category-type");

                        const url = '/document-categories/delete';
                        const method = 'POST';
                        const obj = { category_id };

                        const {error,data} = await fetchApi(url, method, obj);

                        if(error){
                          alert(error.message);
                          return;
                        }

                        if (data) {
                            row.remove();
                            alert(data.message);
                        }
                    }

                    if (event.target.closest(".update-btn")) {
                        const row = event.target.closest("tr");
                        const category_id = row.getAttribute("data-category-type");

                        const url = `/document-categories/fetch/${category_id}`;
                        const method = 'GET';

                        const {error,data} = await fetchApi(url, method, null);
                        
                        if(error){
                          alert(error.message);
                          return;
                        }

                        if (data) {
                            console.log('data update ', JSON.stringify(data));
                            appenHtmlToModal(data);
                            openModal();
                        }

                    }
                });


                function appenHtmlToModal(data) {

                    const category_data = data ?? [];
                    const category_name = category_data[0].document_category;
                    const category_abbr = category_data[0].category_abbr;
                    const parent_id = category_data[0].parent_id ?? '';
                    const description = category_data[0].description;
                    const category_id = category_data[0].category_id;

                    const modalContent = `<div class="frame-container">
                        <div class="frame-title">
                            <span>Document Categories</span>
                        </div>
                        <div class="frame-content">
                            <div class="flex flex-col flex-wrap gap-y-4">

                                <div class="mb-4 w-full px-2">
                                    <div class="lms-input-container">
                                        <input id="category-name-edit" class="lms-input" type="text" placeholder="" value="${category_name}">
                                        <label for="category-name-edit" class="lms-placeholder">Category
                                            Name<span>*</span></label>
                                    </div>
                                </div>

                                <div class="mb-4 w-full px-2">
                                    <div class="lms-input-container">
                                        <input id="category-abbr-edit" class="lms-input" type="text" placeholder="" value="${category_abbr}">
                                        <label for="category-abbr-edit" class="lms-placeholder">Category
                                            Abbreviation<span>*</span></label>
                                    </div>
                                </div>

                                <div class="mb-4 w-full px-2">
                                    <div class="lms-input-container">
                                        <input id="description-edit" class="lms-input" type="text" placeholder="" value="${description}">
                                        <label for="description-edit"
                                            class="lms-placeholder">Description<span>*</span></label>
                                    </div>
                                </div>

                                <div class="mb-4 w-full px-2">
                                    <div class="lms-input-container">
                                        <select id="parent-category-edit" class="lms-dropdropdown">
                                            <option value="" disabled selected hidden>Select Parent Category</option>
                                            <% documentCategories.forEach((type, index)=> { %>
                                                <option value="<%= type.category_id %>">
                                                    <%= type.document_category %>
                                                </option>
                                                <% }) %>
                                        </select>
                                        <div class="lms-cut-dropdown"></div>
                                        <label for="type" class="lms-placeholder-dropdown">Category
                                            Name<span>*</span></label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`

                    document.getElementById("modal-content").innerHTML = modalContent;
                    document.getElementById("update-submit-btn").setAttribute("data-category-id", category_id);

                    const options = document.getElementById("parent-category-edit");
                    for (let i = 0; i < options.length; i++) {
                        if (options[i].value == parent_id) {
                            options[i].selected = true;
                            break;
                        }
                    }
                }

                document.getElementById('update-submit-btn').addEventListener('click', async (event) => {
                    const category_id = event.target.getAttribute("data-category-id");
                    const document_category = document.getElementById("category-name-edit").value;
                    const category_abbr = document.getElementById("category-abbr-edit").value;
                    const description = document.getElementById("description-edit").value;
                    const parent_id = document.getElementById("parent-category-edit").value;

                    const url = '/document-categories/update';
                    const method = 'POST';
                    const obj = { category_id, document_category, category_abbr, description, parent_id };

                    const {error,data} = await fetchApi(url, method, obj);
                    
                    if(error){
                      alert(error.message);
                      return;
                    }

                    if (data) {
                        document.getElementById('category-name-edit').value = '';
                        document.getElementById('category-abbr-edit').value = '';
                        document.getElementById('description-edit').value = '';
                        document.getElementById('parent-category-edit').options[0].selected = true;

                        const row = document.querySelector(`tr[data-category-type="${category_id}"]`);
                        const rowIndex = row.firstElementChild.innerText;
                        const tableBody = document.querySelector('tbody');
                        const rowCount = tableBody.rows.length;
                        row.innerHTML = `<td class="p-4 text-sm text-gray-700 text-center font-semibold ">
                                            ${rowIndex}
                                         </td>
                                         <td class="p-4 text-sm text-gray-700 ">
                                           ${document_category}
                                         </td>
                                         <td class="p-4 text-sm text-gray-700 ">
                                             ${category_abbr}
                                         </td>
                                        <td class="p-4 text-sm text-gray-700 ">
                                            ${description}
                                        </td>
                                        <td class="p-4 text-sm text-gray-700 ">
                                        </td>
                                        <td class="p-4 text-center relative">
                                            <button onclick="toggleDropdown(event)"
                                                class="focus:outline-none text-gray-600 px-4"><i
                                                    class="fa-solid fa-ellipsis-vertical"></i></button>

                                            <div id="dropdown-0"
                                                class="dropdown text-sm hidden absolute bottom-0 right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10">
                                                <a href="#"
                                                    class="block px-4 py-2 text-gray-700 hover:bg-gray-100 flex items-center update-btn">
                                                    <i class="text-red-500 fa-solid fa-pen-to-square"></i>
                                                    <span class="ml-2">Update</span>
                                                </a>
                                                <a href="#"
                                                    class="block px-4 py-2 text-gray-700 hover:bg-gray-100 flex items-center delete-btn">
                                                    <i class="text-red-500 fa-solid fa-trash-can"></i><span
                                                        class="ml-2">Delete</span>
                                                </a>
                                            </div>
                                        </td>`;

                        closeModal();
                        alert(data.message);
                    }
                    console.log('data ', JSON.stringify(data));
                });

            </script>
    </body>